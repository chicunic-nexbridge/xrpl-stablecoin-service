{
  "openapi": "3.0.3",
  "info": {
    "title": "Demo Bank API",
    "version": "0.1.0",
    "description": "Simulated bank system for XRPL stablecoin platform"
  },
  "servers": [
    {
      "url": "/",
      "description": "Current server"
    }
  ],
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "required": ["error"],
        "properties": {
          "error": { "type": "string" }
        }
      },
      "BankAccount": {
        "type": "object",
        "properties": {
          "accountId": { "type": "string" },
          "accountNumber": { "type": "string" },
          "accountType": { "type": "string", "enum": ["personal", "corporate"] },
          "accountHolder": { "type": "string" },
          "bankCode": { "type": "string" },
          "branchCode": { "type": "string" },
          "balance": { "type": "number" },
          "transactionSequence": { "type": "integer" },
          "pubsubEnabled": {
            "type": "boolean",
            "description": "Whether Pub/Sub notifications are enabled for incoming transfers (corporate only)"
          },
          "createdAt": { "type": "string" },
          "updatedAt": { "type": "string" }
        }
      },
      "BankTransaction": {
        "type": "object",
        "properties": {
          "transactionId": { "type": "string" },
          "accountId": { "type": "string" },
          "type": { "type": "string", "enum": ["atm_in", "atm_out", "transfer_in", "transfer_out"] },
          "amount": { "type": "number" },
          "balance": { "type": "number" },
          "counterparty": {
            "type": "object",
            "nullable": true,
            "properties": {
              "bankCode": { "type": "string" },
              "branchCode": { "type": "string" },
              "accountNumber": { "type": "string" },
              "accountHolder": { "type": "string" }
            }
          },
          "sequenceNumber": { "type": "integer" },
          "description": { "type": "string" },
          "virtualAccountNumber": { "type": "string" },
          "virtualAccountLabel": { "type": "string" },
          "createdAt": { "type": "string" }
        }
      },
      "BankVirtualAccount": {
        "type": "object",
        "properties": {
          "virtualAccountId": { "type": "string" },
          "accountNumber": { "type": "string" },
          "branchCode": { "type": "string" },
          "parentAccountId": { "type": "string" },
          "parentAccountNumber": { "type": "string" },
          "label": { "type": "string" },
          "isActive": { "type": "boolean" },
          "createdAt": { "type": "string" },
          "updatedAt": { "type": "string" }
        }
      }
    }
  },
  "paths": {
    "/health": {
      "get": {
        "operationId": "bankHealthCheck",
        "summary": "Health check",
        "tags": ["Health"],
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["status", "timestamp"],
                  "properties": {
                    "status": { "type": "string", "example": "ok" },
                    "timestamp": { "type": "string", "format": "date-time" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/accounts": {
      "post": {
        "operationId": "createBankAccount",
        "summary": "Create a new bank account",
        "tags": ["Account"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["pin", "accountHolder"],
                "properties": {
                  "pin": { "type": "string", "minLength": 4, "maxLength": 4, "pattern": "^[0-9]{4}$" },
                  "accountHolder": { "type": "string", "minLength": 1 },
                  "accountType": { "type": "string", "enum": ["personal", "corporate"], "default": "personal" }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Account created",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/BankAccount" }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/accounts/login": {
      "post": {
        "operationId": "bankLogin",
        "summary": "Login to bank account",
        "tags": ["Account"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["branchCode", "accountNumber", "pin"],
                "properties": {
                  "branchCode": { "type": "string" },
                  "accountNumber": { "type": "string" },
                  "pin": { "type": "string", "minLength": 4, "maxLength": 4, "pattern": "^[0-9]{4}$" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "token": { "type": "string" },
                    "account": { "$ref": "#/components/schemas/BankAccount" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid credentials",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/accounts/lookup": {
      "get": {
        "operationId": "lookupBankAccount",
        "summary": "Lookup account by branch code and account number",
        "tags": ["Account"],
        "parameters": [
          {
            "name": "branchCode",
            "in": "query",
            "required": true,
            "schema": { "type": "string" }
          },
          {
            "name": "accountNumber",
            "in": "query",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Account lookup result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "accountHolder": { "type": "string" },
                    "bankCode": { "type": "string" },
                    "branchCode": { "type": "string" },
                    "accountNumber": { "type": "string" },
                    "isVirtualAccount": { "type": "boolean" },
                    "parentAccountNumber": { "type": "string" },
                    "label": { "type": "string" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Missing query parameters",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "404": {
            "description": "Account not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/accounts/me": {
      "get": {
        "operationId": "getBankAccountMe",
        "summary": "Get current account info",
        "tags": ["Account"],
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Account info",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/BankAccount" }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      },
      "patch": {
        "operationId": "updateBankAccountMe",
        "summary": "Update current account info",
        "tags": ["Account"],
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "accountHolder": { "type": "string", "minLength": 1 },
                  "pin": { "type": "string", "minLength": 4, "maxLength": 4, "pattern": "^[0-9]{4}$" },
                  "oldPin": { "type": "string", "minLength": 4, "maxLength": 4, "pattern": "^[0-9]{4}$" },
                  "pubsubEnabled": {
                    "type": "boolean",
                    "description": "Enable/disable Pub/Sub notifications for incoming transfers (corporate only)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Account updated",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/BankAccount" }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/accounts/me/api-token": {
      "post": {
        "operationId": "generateApiToken",
        "summary": "Generate a long-lived API token (corporate only)",
        "tags": ["Account"],
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "API token generated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["token"],
                  "properties": {
                    "token": { "type": "string" }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "403": {
            "description": "Forbidden - not a corporate account",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "404": {
            "description": "Account not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/accounts/me/virtual-accounts": {
      "post": {
        "operationId": "createVirtualAccount",
        "summary": "Create a virtual account (corporate only)",
        "tags": ["Virtual Account"],
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["label"],
                "properties": {
                  "label": { "type": "string", "minLength": 1 }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Virtual account created",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/BankVirtualAccount" }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "403": {
            "description": "Forbidden - not a corporate account",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      },
      "get": {
        "operationId": "listVirtualAccounts",
        "summary": "List virtual accounts (corporate only)",
        "tags": ["Virtual Account"],
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Virtual account list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/BankVirtualAccount" }
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - not a corporate account",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/accounts/me/virtual-accounts/{virtualAccountId}": {
      "get": {
        "operationId": "getVirtualAccount",
        "summary": "Get virtual account details (corporate only)",
        "tags": ["Virtual Account"],
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "virtualAccountId",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Virtual account details",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/BankVirtualAccount" }
              }
            }
          },
          "403": {
            "description": "Forbidden - not a corporate account",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "404": {
            "description": "Virtual account not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      },
      "patch": {
        "operationId": "updateVirtualAccount",
        "summary": "Update virtual account (corporate only)",
        "tags": ["Virtual Account"],
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "virtualAccountId",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "label": { "type": "string", "minLength": 1 },
                  "isActive": { "type": "boolean" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Virtual account updated",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/BankVirtualAccount" }
              }
            }
          },
          "403": {
            "description": "Forbidden - not a corporate account",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "404": {
            "description": "Virtual account not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/atm/deposit": {
      "post": {
        "operationId": "atmDeposit",
        "summary": "ATM cash deposit",
        "tags": ["ATM"],
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["amount", "pin"],
                "properties": {
                  "amount": { "type": "number", "minimum": 1 },
                  "pin": { "type": "string", "minLength": 4, "maxLength": 4, "pattern": "^[0-9]{4}$" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Deposit successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "balance": { "type": "number" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/atm/withdrawal": {
      "post": {
        "operationId": "atmWithdrawal",
        "summary": "ATM cash withdrawal",
        "tags": ["ATM"],
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["amount", "pin"],
                "properties": {
                  "amount": { "type": "number", "minimum": 1 },
                  "pin": { "type": "string", "minLength": 4, "maxLength": 4, "pattern": "^[0-9]{4}$" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Withdrawal successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "balance": { "type": "number" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/transfers": {
      "post": {
        "operationId": "createTransfer",
        "summary": "Transfer funds to another account",
        "tags": ["Transfer"],
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["toBranchCode", "toAccountNumber", "amount"],
                "properties": {
                  "toBranchCode": { "type": "string", "minLength": 3, "maxLength": 3, "pattern": "^[0-9]{3}$" },
                  "toAccountNumber": { "type": "string" },
                  "amount": { "type": "number", "minimum": 1 },
                  "pin": {
                    "type": "string",
                    "minLength": 4,
                    "maxLength": 4,
                    "pattern": "^[0-9]{4}$",
                    "description": "Required for session (cookie) auth. Not required for API token auth."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Transfer successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "balance": { "type": "number" },
                    "transactionId": { "type": "string" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/api/v1/transactions": {
      "get": {
        "operationId": "listTransactions",
        "summary": "List transaction history",
        "tags": ["Transaction"],
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Transaction list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/BankTransaction" }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    }
  }
}
